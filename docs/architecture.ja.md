# xtrade ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

[ğŸ‡ºğŸ‡¸ English](./architecture.md)

## æ¦‚è¦

xtrade ã¯ã€X (æ—§ Twitter) ã®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚°ãƒ©ãƒ•ã‚’æ´»ç”¨ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€xtrade ã®æŠ€è¡“çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è¨­è¨ˆæ€æƒ³ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                         â”‚
â”‚              (Next.js App Router / React)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ HTTPS
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Vercel (ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           Next.js App Router                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚  Pages (SSR)     â”‚  â”‚  Route Handlers      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  - /            â”‚  â”‚  - /api/auth/**      â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  - /rooms/*     â”‚  â”‚  - /api/trades/**    â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  - /trades/*    â”‚  â”‚  - /api/rooms/**     â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚              â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ BetterAuthâ”‚  â”‚   Neon   â”‚  â”‚CloudFlareâ”‚
â”‚  + X OAuthâ”‚  â”‚   (DB)   â”‚  â”‚   DNS    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ

xtrade ã¯ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã™ã¹ã¦ 1 ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¾ã™ã€‚

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```text
xtrade/
â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”œâ”€â”€ (app)/             # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ layout.tsx     # å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”‚   â”œâ”€â”€ page.tsx       # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”‚   â”‚   â”œâ”€â”€ rooms/         # ãƒ«ãƒ¼ãƒ ä¸€è¦§ãƒ»è©³ç´°
â”‚   â”‚   â””â”€â”€ trades/        # ãƒˆãƒ¬ãƒ¼ãƒ‰ä¸€è¦§ãƒ»è©³ç´°
â”‚   â”œâ”€â”€ api/               # Route Handlersï¼ˆAPIï¼‰
â”‚   â”‚   â”œâ”€â”€ auth/          # BetterAuth ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”‚   â””â”€â”€ [...all]/route.ts
â”‚   â”‚   â”œâ”€â”€ trades/        # ãƒˆãƒ¬ãƒ¼ãƒ‰ API
â”‚   â”‚   â””â”€â”€ rooms/         # ãƒ«ãƒ¼ãƒ  API
â”‚   â””â”€â”€ globals.css        # ã‚°ãƒ­ãƒ¼ãƒãƒ« CSS
â”‚
â”œâ”€â”€ src/                   # å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”‚   â”œâ”€â”€ lib/               # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ auth.ts        # BetterAuth ã‚µãƒ¼ãƒãƒ¼è¨­å®š
â”‚   â”‚   â””â”€â”€ auth-client.ts # BetterAuth ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ db/                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ schema.ts      # Drizzle ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â”‚   â””â”€â”€ drizzle.ts     # Drizzle ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ modules/           # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ trades/        # ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ‰ãƒ¡ã‚¤ãƒ³
â”‚   â”‚   â”‚   â””â”€â”€ service.ts # ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â””â”€â”€ rooms/         # ãƒ«ãƒ¼ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³
â”‚   â”‚       â””â”€â”€ service.ts # ãƒ«ãƒ¼ãƒ ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â””â”€â”€ components/        # å…±é€š UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚
â”œâ”€â”€ terraform/             # ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼ˆIaCï¼‰
â”‚   â”œâ”€â”€ modules/           # å†åˆ©ç”¨å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ cloudflare/    # CloudFlare DNS ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ vercel/        # Vercel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â””â”€â”€ neon/          # Neon DB ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå°†æ¥å¯¾å¿œï¼‰
â”‚   â”œâ”€â”€ environments/      # ç’°å¢ƒã”ã¨ã®è¨­å®š
â”‚   â”‚   â”œâ”€â”€ dev/           # dev ç’°å¢ƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â”‚   â””â”€â”€ terraform.tfvars
â”‚   â”‚   â””â”€â”€ prod/          # prod ç’°å¢ƒ
â”‚   â”‚       â”œâ”€â”€ main.tf
â”‚   â”‚       â”œâ”€â”€ variables.tf
â”‚   â”‚       â””â”€â”€ terraform.tfvars
â”‚   â””â”€â”€ global/            # ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒªã‚½ãƒ¼ã‚¹
â”‚       â”œâ”€â”€ dns.tf         # DNS ã‚¾ãƒ¼ãƒ³
â”‚       â””â”€â”€ backend.tf     # Terraform state ç®¡ç†
â”‚
â”œâ”€â”€ docs/                  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ architecture.md    # æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ api.md             # API ä»•æ§˜æ›¸
â”‚   â””â”€â”€ agents/            # Agent åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚
â”œâ”€â”€ .github/               # GitHub é–¢é€£
â”‚   â”œâ”€â”€ workflows/         # GitHub Actions
â”‚   â”œâ”€â”€ CODEOWNERS         # ã‚³ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠãƒ¼
â”‚   â””â”€â”€ pull_request_template.md
â”‚
â”œâ”€â”€ .claude/               # Claude Code Agent è¨­å®š
â”‚   â””â”€â”€ agents/            # Agent å®šç¾©
â”‚       â”œâ”€â”€ arch.md        # ArchAgent
â”‚       â”œâ”€â”€ db.md          # DBAgent
â”‚       â”œâ”€â”€ auth.md        # AuthAgent
â”‚       â”œâ”€â”€ api.md         # APIAgent
â”‚       â”œâ”€â”€ ui.md          # UIAgent
â”‚       â””â”€â”€ test.md        # TestAgent
â”‚
â””â”€â”€ scripts/               # é–‹ç™ºç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

## ãƒ¬ã‚¤ãƒ¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

xtrade ã¯ä»¥ä¸‹ã®ãƒ¬ã‚¤ãƒ¤ã§æ§‹æˆã•ã‚Œã¾ã™ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Presentation Layer                 â”‚
â”‚         (app/**/*.tsx - Pages/UI)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Layer                  â”‚
â”‚      (app/api/**/*.ts - Route Handlers)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Domain Layer                      â”‚
â”‚     (src/modules/**/service.ts - Services)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Infrastructure Layer                 â”‚
â”‚  (src/db/drizzle.ts, src/lib/auth.ts - DB/Auth)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¬ã‚¤ãƒ¤ã®è²¬å‹™

1. **Presentation Layer** (`app/**/*.tsx`)
   - UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãƒšãƒ¼ã‚¸
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®çŠ¶æ…‹ç®¡ç†

2. **Application Layer** (`app/api/**/*.ts`)
   - Route Handlers ã«ã‚ˆã‚‹ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
   - ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¤‰æ›
   - èªè¨¼ãƒ»èªå¯ãƒã‚§ãƒƒã‚¯
   - Domain Layer ã®å‘¼ã³å‡ºã—

3. **Domain Layer** (`src/modules/**/service.ts`)
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
   - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ã®å®Ÿè£…
   - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

4. **Infrastructure Layer** (`src/db/`, `src/lib/`)
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
   - å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº
   - èªè¨¼åŸºç›¤

## Agent æ§‹æˆã¨è²¬å‹™

xtrade ã§ã¯ Claude Code ã® Sub Agent ã‚’æ´»ç”¨ã—ã¦è²¬å‹™ã‚’åˆ†é›¢ã—é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

### Agent ä¸€è¦§

#### 1. ArchAgentï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆãƒ»è¦ç´„ï¼‰

**å½¹å‰²**: xtrade å…¨ä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨é–‹ç™ºè¦ç´„ã‚’è¨­è¨ˆãƒ»ç¶­æŒã™ã‚‹ã€‚

**æ‹…å½“ç¯„å›²**:

- `README.md`, `docs/architecture.md`, `docs/api.md`
- Next.js æ§‹æˆï¼ˆApp Routerã€Route Handlers ã®ãƒ‘ã‚¹è¨­è¨ˆï¼‰
- `src/` ä»¥ä¸‹ã®ãƒ¬ã‚¤ãƒ¤åˆ†ã‘ãƒ«ãƒ¼ãƒ«
- ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„
- ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é¸å®š

**ç¦æ­¢äº‹é …**:

- å…·ä½“çš„ãª API å®Ÿè£…ã‚„ UI å®Ÿè£…ã¸ã®ç›´æ¥çš„ãªå¤‰æ›´
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®å¤§å¹…ãªæ”¹ä¿®

#### 2. DBAgentï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ã‚¹ã‚­ãƒ¼ãƒç®¡ç†ï¼‰

**å½¹å‰²**: Neon + Drizzle ã® DB å‘¨ã‚Šã‚’ä¸€æ‰‹ã«å¼•ãå—ã‘ã‚‹ã€‚

**æ‹…å½“ç¯„å›²**:

- `src/db/schema.ts`, `src/db/drizzle.ts`, `drizzle.config.ts`
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆãƒ»é©ç”¨
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»enum å®šç¾©

**ç¦æ­¢äº‹é …**:

- API ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- UI å®Ÿè£…

#### 3. AuthAgentï¼ˆèªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰

**å½¹å‰²**: BetterAuth ã®è¨­å®šã¨ X OAuth ã®é…ç·šã‚’å…¨ã¦æ‹…å½“ã™ã‚‹ã€‚

**æ‹…å½“ç¯„å›²**:

- `src/lib/auth.ts`ï¼ˆBetterAuth ã‚µãƒ¼ãƒãƒ¼è¨­å®šï¼‰
- `src/lib/auth-client.ts`ï¼ˆReact ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰
- `app/api/auth/[...all]/route.ts`
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼

**ç¦æ­¢äº‹é …**:

- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‰ / ãƒ«ãƒ¼ãƒ ãªã©ï¼‰
- DB ã‚¹ã‚­ãƒ¼ãƒæœ¬ä½“ã®å¤‰æ›´

#### 4. APIAgentï¼ˆAPIãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

**å½¹å‰²**: å–å¼•ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’å®ˆã‚Šã¤ã¤ã€Route Handlers ã§ API ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**æ‹…å½“ç¯„å›²**:

- `app/api/trades/**/*.ts`
- `app/api/rooms/**/*.ts`
- `src/modules/**/service.ts`ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹å±¤ï¼‰

**ç¦æ­¢äº‹é …**:

- Drizzle ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©å¤‰æ›´
- UI å®Ÿè£…
- Auth è¨­å®šã®å¤§å¹…å¤‰æ›´

#### 5. UIAgentï¼ˆUIãƒ»UXï¼‰

**å½¹å‰²**: æœ€ä½é™ã® UI ã‚’ã‚µã‚¯ã‚µã‚¯çµ„ã‚€ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’é€”åˆ‡ã‚Œãªãç¹‹ãã€‚

**æ‹…å½“ç¯„å›²**:

- `app/**/page.tsx`
- å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ãƒŠãƒ“ï¼ˆ`app/layout.tsx`ï¼‰
- UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`src/components/**`ï¼‰

**ç¦æ­¢äº‹é …**:

- è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
- DB ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹

#### 6. TestAgentï¼ˆãƒ†ã‚¹ãƒˆãƒ»å“è³ªä¿è¨¼ï¼‰

**å½¹å‰²**: ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å˜ä½ã§å£Šã‚Œã¦ãªã„ã‹ã‚’æ‹…ä¿ã™ã‚‹ã€‚

**æ‹…å½“ç¯„å›²**:

- Unit ãƒ†ã‚¹ãƒˆï¼š`src/modules/**/__tests__/*.test.ts`
- API ãƒ†ã‚¹ãƒˆï¼š`app/api/**/__tests__/*.test.ts`
- E2E ãƒ†ã‚¹ãƒˆ

**ç¦æ­¢äº‹é …**:

- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãã®ã‚‚ã®ã®å¤§é‡å®Ÿè£…

### Agent é–“ã®ä¾å­˜é–¢ä¿‚

```mermaid
flowchart LR
    Arch[ArchAgent<br/>è¨­è¨ˆãƒ»è¦ç´„] --> DBA[DBAgent<br/>Drizzle/Neon]
    Arch --> Auth[AuthAgent<br/>BetterAuth/X OAuth]
    Arch --> API[APIAgent<br/>Route Handlers/ãƒ­ã‚¸ãƒƒã‚¯]
    Arch --> UI[UIAgent<br/>UI/UX]

    DBA --> API
    Auth --> API

    API --> Test[TestAgent<br/>E2E/Unit/Lint]
    UI  --> Test
```

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### èªè¨¼ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as UI (Next.js)
    participant API as /api/auth/[...all]
    participant BA as BetterAuth
    participant X as X (Twitter)
    participant DB as Neon DB

    User->>UI: ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    UI->>API: GET /api/auth/signin/twitter
    API->>BA: signIn('twitter')
    BA->>X: OAuth èªè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    X-->>User: X ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
    User->>X: èªè¨¼è¨±å¯
    X-->>API: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    API->>BA: handleCallback()
    BA->>DB: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜
    BA-->>UI: ã‚»ãƒƒã‚·ãƒ§ãƒ³ Cookie ç™ºè¡Œ
    UI-->>User: ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†
```

### ãƒˆãƒ¬ãƒ¼ãƒ‰ä½œæˆãƒ•ãƒ­ãƒ¼ï¼ˆä¾‹ï¼‰

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as UI (page.tsx)
    participant API as /api/trades
    participant Service as TradeService
    participant DB as Drizzle/Neon

    User->>UI: ãƒˆãƒ¬ãƒ¼ãƒ‰ä½œæˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    UI->>API: POST /api/trades
    API->>API: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    API->>Service: createTrade(data)
    Service->>Service: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼
    Service->>DB: insert(trades)
    DB-->>Service: ãƒˆãƒ¬ãƒ¼ãƒ‰ ID
    Service-->>API: ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    API-->>UI: JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    UI-->>User: ãƒˆãƒ¬ãƒ¼ãƒ‰ä½œæˆå®Œäº†
```

## ç’°å¢ƒæ§‹æˆ

xtrade ã¯ local / dev / prod ã® 3 ç’°å¢ƒã§é‹ç”¨ã—ã¾ã™ã€‚

### ç’°å¢ƒã”ã¨ã® URL

| ç’°å¢ƒ | APP URL | DB | å‚™è€ƒ |
| --- | --- | --- | --- |
| local | `http://localhost:3000` | Docker Postgres | é–‹ç™ºç”¨ |
| dev | `https://xtrade-dev.tqer39.dev` | Neon (xtrade-dev) | ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»å‹•ä½œç¢ºèª |
| prod | `https://xtrade.tqer39.dev` | Neon (xtrade-prod) | æœ¬ç•ª |

### ç’°å¢ƒå¤‰æ•°ç®¡ç†

ç’°å¢ƒã”ã¨ã«ç•°ãªã‚‹ç’°å¢ƒå¤‰æ•°ï¼š

- `NEXT_PUBLIC_APP_URL` - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ URL
- `BETTER_AUTH_URL` - BetterAuth ã®ãƒ™ãƒ¼ã‚¹ URL
- `BETTER_AUTH_SECRET` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç½²åç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
- `DATABASE_URL` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—

`.env.example` ã«ã™ã¹ã¦ã®å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¼‰ã—ã€`.env.local` ã§ç’°å¢ƒã”ã¨ã«è¨­å®šã—ã¾ã™ã€‚

## ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼ˆTerraformï¼‰

### DNS / Vercel æ§‹æˆ

```mermaid
flowchart TD
  subgraph DNS[tqer39.dev DNS]
    A[xtrade.tqer39.dev] --> V[Vercel project xtrade]
    B[xtrade-dev.tqer39.dev] --> V
  end

  subgraph Vercel[xtrade ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ]
    V1[Production env<br/>https://xtrade.tqer39.dev]
    V2[Preview/Dev env<br/>https://xtrade-dev.tqer39.dev]
  end

  subgraph Local
    L[localhost:3000<br/>next dev]
  end
```

### ç®¡ç†å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹

#### 1. CloudFlare DNS

- **ãƒªã‚½ãƒ¼ã‚¹**: `tqer39.dev` ã® DNS ã‚¾ãƒ¼ãƒ³
- **ãƒ¬ã‚³ãƒ¼ãƒ‰**:
  - `xtrade.tqer39.dev` â†’ Vercel ã® prod ç’°å¢ƒï¼ˆCNAMEï¼‰
  - `xtrade-dev.tqer39.dev` â†’ Vercel ã® dev ç’°å¢ƒï¼ˆCNAMEï¼‰

#### 2. Vercel

- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: `xtrade`
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³**:
  - Production: `xtrade.tqer39.dev`
  - Preview/Dev: `xtrade-dev.tqer39.dev`
- **ç’°å¢ƒå¤‰æ•°**: Terraform ã§ç®¡ç†

#### 3. Terraform State ç®¡ç†

- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: S3ï¼ˆAWSï¼‰
- **State ãƒ•ã‚¡ã‚¤ãƒ«**: `s3://terraform-tfstate-tqer39-072693953877-ap-northeast-1/xtrade/`

### Terraform ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```text
infra/terraform/
â”œâ”€â”€ modules/           # å†åˆ©ç”¨å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”œâ”€â”€ cloudflare/   # CloudFlare DNS ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”œâ”€â”€ vercel/       # Vercel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â””â”€â”€ neon/         # Neon DB ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”œâ”€â”€ envs/              # ç’°å¢ƒã”ã¨ã®è¨­å®š
â”‚   â”œâ”€â”€ dev/          # dev ç’°å¢ƒ
â”‚   â”‚   â”œâ”€â”€ database/ # Neon ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ frontend/ # Vercel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
â”‚   â”‚   â””â”€â”€ dns/      # CloudFlare DNS ãƒ¬ã‚³ãƒ¼ãƒ‰
â”‚   â””â”€â”€ prod/         # prod ç’°å¢ƒ
â””â”€â”€ config.yml        # å…±é€šè¨­å®š
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### èªè¨¼ãƒ»èªå¯

- BetterAuth ã«ã‚ˆã‚‹ X OAuth èªè¨¼
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ Cookie ã«ã‚ˆã‚‹çŠ¶æ…‹ç®¡ç†
- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ä¿è­·ï¼ˆBetterAuth å†…è”µï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ç®¡ç†

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- Neon ã® SSL æ¥ç¶šå¿…é ˆ
- æ¥ç¶šæ–‡å­—åˆ—ã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ unpooled æ¥ç¶šã‚’ä½¿ç”¨

### Secrets ç®¡ç†

- `.env.local` ã¯ Git ç®¡ç†å¤–
- Vercel ç’°å¢ƒå¤‰æ•°ã¯ Web UI ã§è¨­å®šï¼ˆæš—å·åŒ–ä¿å­˜ï¼‰
- Terraform ã® `terraform.tfvars` ã¯ `.gitignore` ã«è¿½åŠ 
- ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªå€¤ã¯ `sensitive = true` ã‚’è¨­å®š

### CORS / CSP

- Next.js ã® App Router ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒªã‚·ãƒ¼
- API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯èªè¨¼å¿…é ˆ
- å°†æ¥çš„ã« CSP ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ ã‚’æ¤œè¨

## æŠ€è¡“é¸å®šã®ç†ç”±

### Next.js App Router

- SSR ã¨ CSR ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰
- Route Handlers ã«ã‚ˆã‚‹ API å®Ÿè£…
- React Server Components ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

### Drizzle ORM

- TypeScript ãƒã‚¤ãƒ†ã‚£ãƒ–
- å‹å®‰å…¨ãª SQL ãƒ“ãƒ«ãƒ€ãƒ¼
- Neon ã¨ã®ç›¸æ€§ãŒè‰¯ã„

### Neon

- Serverless PostgreSQL
- ãƒ–ãƒ©ãƒ³ãƒæ©Ÿèƒ½ã«ã‚ˆã‚‹ç’°å¢ƒåˆ†é›¢
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### BetterAuth

- X OAuth ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…
- TypeScript ã‚µãƒãƒ¼ãƒˆ
- Next.js ã¨ã®çµ±åˆãŒå®¹æ˜“

### Terraform

- ã‚¤ãƒ³ãƒ•ãƒ©ã®ã‚³ãƒ¼ãƒ‰åŒ–
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
- ç’°å¢ƒã®å†ç¾æ€§

## ä»Šå¾Œã®æ‹¡å¼µè¨ˆç”»

### Phase 1: MVPï¼ˆç¾åœ¨ï¼‰

- X ãƒ­ã‚°ã‚¤ãƒ³
- ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ ã®ä½œæˆãƒ»å‚åŠ 
- åŸºæœ¬çš„ãªå–å¼•æ©Ÿèƒ½

### Phase 2: æ©Ÿèƒ½æ‹¡å¼µ

- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
- ãƒˆãƒ¬ãƒ¼ãƒ‰å±¥æ­´ã®å¯è¦–åŒ–
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°

### Phase 3: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

- Neon Read Replica ã®æ´»ç”¨
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã®è¿½åŠ ï¼ˆRedisï¼‰
- CDN ã®æœ€é©åŒ–

## å¤‰æ›´å±¥æ­´

- 2025-11-23: åˆç‰ˆä½œæˆï¼ˆArchAgentï¼‰
