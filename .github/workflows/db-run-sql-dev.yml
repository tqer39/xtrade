name: DB Run SQL - dev

on:
  workflow_dispatch:
    inputs:
      SQL_FILE:
        description: 'å®Ÿè¡Œã™ã‚‹SQLãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆscripts/db/ é…ä¸‹ï¼‰'
        required: true
        type: choice
        options:
          - sync-migration-history.sql
      DRY_RUN:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆSQLã‚’è¡¨ç¤ºã™ã‚‹ã®ã¿ã€å®Ÿè¡Œã—ãªã„ï¼‰'
        required: true
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '24'

jobs:
  db-run-sql-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate SQL file exists
        id: validate
        run: |
          SQL_PATH="scripts/db/${{ inputs.SQL_FILE }}"
          if [ ! -f "$SQL_PATH" ]; then
            echo "âŒ SQLãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $SQL_PATH"
            exit 1
          fi
          echo "sql-path=$SQL_PATH" >> "$GITHUB_OUTPUT"
          echo "âœ… SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¾ã—ãŸ: $SQL_PATH"

      - name: Show SQL content (dry run)
        if: inputs.DRY_RUN == true
        run: |
          echo "ğŸ“„ å®Ÿè¡Œäºˆå®šã®SQL:"
          echo "---"
          cat "${{ steps.validate.outputs.sql-path }}"
          echo "---"
          echo "âš ï¸ ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€SQLã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"

      - name: Run SQL
        if: inputs.DRY_RUN == false
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
        run: |
          echo "ğŸš€ SQLã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™: ${{ inputs.SQL_FILE }}"
          psql "$DATABASE_URL" -f "${{ steps.validate.outputs.sql-path }}"
          echo "âœ… SQLã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Verify migration history
        if: inputs.DRY_RUN == false && inputs.SQL_FILE == 'sync-migration-history.sql'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
        run: |
          echo "ğŸ“‹ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’ç¢ºèªã—ã¦ã„ã¾ã™:"
          psql "$DATABASE_URL" -c "SELECT * FROM __drizzle_migrations ORDER BY created_at;"
