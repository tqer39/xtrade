name: DB Migration - dev

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/db/schema.ts'
      - 'src/db/migrations/**'
      - 'drizzle.config.ts'
  push:
    branches:
      - main
    paths:
      - 'src/db/schema.ts'
      - 'src/db/migrations/**'
      - 'drizzle.config.ts'
  workflow_dispatch:
    inputs:
      DRY_RUN:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã›ãšã«ç¢ºèªã®ã¿ï¼‰'
        required: true
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä¸­æ–­ã—ãªã„

env:
  NODE_VERSION: '24'
  DRY_RUN: ${{ inputs.DRY_RUN == false && 'false' || 'true' }}

jobs:
  db-migrate-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          experimental: true

      - name: Install dependencies
        run: npm ci

      - name: Check migration files
        id: check-migration
        run: |
          if [ -d "src/db/migrations" ] && [ "$(ls -A src/db/migrations)" ]; then
            echo "has-migrations=true" >> "$GITHUB_OUTPUT"
            echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            ls -la "src/db/migrations"
          else
            echo "has-migrations=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: Dry run - Check migration plan (PR only)
        if: github.event_name == 'pull_request' && steps.check-migration.outputs.has-migrations == 'true'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
        run: |
          echo "ğŸ” ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ï¼ˆå®Ÿè¡Œã¯ã—ã¾ã›ã‚“ï¼‰"
          npm run db:generate
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”ŸæˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"

      - name: Run database migration (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check-migration.outputs.has-migrations == 'true' && env.DRY_RUN == 'false'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
        run: |
          echo "ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™"
          npm run db:migrate
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"

      - name: Run database migration (manual trigger)
        if: github.event_name == 'workflow_dispatch' && steps.check-migration.outputs.has-migrations == 'true' && env.DRY_RUN == 'false'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
        run: |
          echo "ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‰‹å‹•å®Ÿè¡Œã—ã¦ã„ã¾ã™"
          npm run db:migrate
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.check-migration.outputs.has-migrations == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª

            âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”ŸæˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚

            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

            ã“ã®PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã¨ã€\`main\`ãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«è‡ªå‹•çš„ã«devç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

            **æ³¨æ„**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æœ¬ç•ªç’°å¢ƒã«ã¯è‡ªå‹•é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚æœ¬ç•ªç’°å¢ƒã¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

            ### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

            \`\`\`
            src/db/migrations/
            \`\`\`

            ---
            ğŸ¤– ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Notify success
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main' && env.DRY_RUN == 'false'
        run: |
          echo "âœ… devç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
